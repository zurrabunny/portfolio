---
import Container from "/src/components/Container.astro";
import ImageModal from "./ImageModal.astro";
import Music from "./work_modules/Music.astro";
import Illustrations from "./work_modules/Illustrations.astro";
import Animation from "./work_modules/Animations.astro";
import ThreeD from "./work_modules/ThreeD.astro";
import Storyboards from "./work_modules/Storyboards.astro";
---

<main class="content">
  <Container variant="static">
    <div class="tabs">
      <button data-tab="Illustrations" class="active">Illustrations</button>
      <button data-tab="Animation">Animation</button>
      <button data-tab="3D">3D</button>
      <button data-tab="Storyboard">Storyboard</button>
      <button data-tab="Music">Music</button>
    </div>

    <!-- Divider around title -->
    <div class="title-divider">
      <div class="line"></div>
      <h1 id="tab-title">Illustrations</h1>
      <div class="line"></div>
    </div>

    <!-- Tag Filter -->
    <div class="tag-filter" id="tagFilter"></div>

    <!-- Sections -->
    <section class="bento-gallery" id="illustrations">
      <Illustrations />
    </section>

    <section class="bento-gallery" id="animation" style="display:none">
      <Animation />
    </section>

    <section class="bento-gallery" id="3d" style="display:none">
      <ThreeD />
    </section>

    <section class="bento-gallery" id="storyboard" style="display:none">
      <Storyboards />
    </section>

    <div class="music-row" id="music" style="display:none">
      <Music />
    </div>
  </Container>
  <ImageModal />
</main>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const animationSpeed = 0.6;
  const staggerDelay = 0.02;
  const tabs = document.querySelectorAll(".tabs button");
  const sections = {
    Illustrations: document.getElementById("illustrations"),
    Animation: document.getElementById("animation"),
    "3D": document.getElementById("3d"),
    Storyboard: document.getElementById("storyboard"),
    Music: document.getElementById("music")
  };
  const title = document.getElementById("tab-title");
  const lines = document.querySelectorAll(".title-divider .line");
  const tagFilter = document.getElementById("tagFilter");

  let activeTag = "All";

  // Wrap title letters
  const wrapTitleLetters = () => {
    if (!title.dataset.wrapped) {
      const text = title.textContent;
      title.innerHTML = "";
      text.split("").forEach(char => {
        const span = document.createElement("span");
        span.textContent = char;
        span.style.display = "inline-block";
        span.style.opacity = 0;
        title.appendChild(span);
      });
      title.dataset.wrapped = "true";
    }
  };
  wrapTitleLetters();

  // Animate title letters
  const animateTitle = (text) => {
    const letters = Array.from(title.querySelectorAll("span"));
    letters.forEach((span, i) => {
      span.textContent = text[i] || "";
      span.style.opacity = 0;
      span.style.animation = "none";
      setTimeout(() => {
        span.style.animation = `fadeInUp ${animationSpeed}s forwards`;
      }, i * staggerDelay * 1000);
    });

    lines.forEach((line, i) => {
      line.style.opacity = 0;
      line.style.transform = "scaleX(0)";
      line.style.animation = "none";
      setTimeout(() => {
        line.style.animation = `lineIn ${animationSpeed}s forwards`;
      }, i * staggerDelay * 1000);
    });
  };

  // Animate gallery items (with stagger)
  const animateGalleryItems = (items) => {
    items.forEach((item, index) => {
      item.style.opacity = 0;
      item.style.transform = "scale(0.95)";
      item.style.display = "inline-block";
      setTimeout(() => {
        item.style.transition = `opacity ${animationSpeed}s, transform ${animationSpeed}s`;
        item.style.opacity = 1;
        item.style.transform = "scale(1)";
      }, index * staggerDelay * 1000);
    });
  };

  // Animate music players
  const animateMusicPlayers = () => {
    const players = document.querySelectorAll("#music .music-player");
    players.forEach((player, i) => {
      const delay = i * staggerDelay * 1000;
      player.style.opacity = 0;
      player.style.animation = "none";
      setTimeout(() => {
        player.style.animation = `fadeInUp ${animationSpeed}s forwards`;
      }, delay);
      const info = player.querySelector(".music-info");
      if (info) {
        info.style.opacity = 0;
        info.style.animation = "none";
        setTimeout(() => {
          info.style.animation = `fadeInUp ${animationSpeed}s forwards`;
        }, delay + (staggerDelay * 1000 / 2));
      }
    });
  };

  // Wait for items
  function waitForItems(selector, callback) {
    const interval = setInterval(() => {
      const items = document.querySelectorAll(selector);
      if (items.length) {
        clearInterval(interval);
        callback(items);
      }
    }, 50);
  }

  // Generate tag buttons (only once)
  function generateTagButtons() {
    waitForItems("#illustrations .bento-item", (items) => {
      if (!tagFilter) return;

      if (!tagFilter.dataset.generated) {
        const allTags = new Set(["All"]);
        items.forEach(item => {
          const tags = item.dataset.tags?.split(",").map(t => t.trim()) || [];
          tags.forEach(tag => allTags.add(tag));
        });

        tagFilter.innerHTML = "";
        Array.from(allTags).forEach(tag => {
          const btn = document.createElement("button");
          btn.dataset.tag = tag;
          btn.textContent = tag;
          btn.className = "tag-btn";
          tagFilter.appendChild(btn);

          if (tag === activeTag) btn.classList.add("active");

          btn.addEventListener("click", () => {
            document.querySelectorAll(".tag-btn")?.forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            activeTag = tag;

            items.forEach(item => {
              const itemTags = item.dataset.tags?.split(",").map(t => t.trim()) || [];
              if (tag === "All" || itemTags.includes(tag)) {
                item.style.display = "inline-block";
                item.style.opacity = 1;
                item.style.transform = "scale(1)";
              } else {
                item.style.display = "none";
                item.style.opacity = 0;
              }
            });
          });
        });

        tagFilter.dataset.generated = "true";
      }
    });
  }

  // Animate tags (stagger, always on tab switch)
  function animateTagButtons() {
    if (!tagFilter) return;
    const buttons = tagFilter.querySelectorAll(".tag-btn");
    buttons.forEach((btn, i) => {
      btn.style.opacity = 0;
      btn.style.transform = "translateY(10px)";
      btn.style.transition = "none";

      setTimeout(() => {
        btn.style.transition = "opacity 0.4s, transform 0.4s";
        btn.style.opacity = 1;
        btn.style.transform = "translateY(0)";
      }, i * staggerDelay * 4000);
    });
  }

  // Tab click
  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      const selected = tab.dataset.tab;
      tabs.forEach(t => t.classList.remove("active"));
      tab.classList.add("active");

      Object.keys(sections).forEach(key => {
        sections[key].style.display = key === selected ? (key === "Music" ? "flex" : "block") : "none";
      });

      if (selected === "Illustrations") {
        tagFilter.style.display = "flex";
        generateTagButtons();
        animateTagButtons(); // reset and stagger animation on each tab switch

        const items = sections["Illustrations"].querySelectorAll(".bento-item");
        animateGalleryItems(items);

        items.forEach(item => {
          const itemTags = item.dataset.tags?.split(",").map(t => t.trim()) || [];
          if (!(activeTag === "All" || itemTags.includes(activeTag))) {
            item.style.display = "none";
            item.style.opacity = 0;
          }
        });
      } else {
        tagFilter.style.display = "none";

        const items = sections[selected].querySelectorAll(".bento-item");
        animateGalleryItems(items);
      }

      animateTitle(selected);

      if (selected === "Music") animateMusicPlayers();
    });
  });

  // Default tab
  document.querySelector('.tabs button[data-tab="Illustrations"]')?.click();
});
</script>

<style>

main.content {
  flex:1;
  margin-left:260px;
  padding:2rem;
  color:var(--text-dark);
  position:relative;
  z-index:1;
}

.tabs {
  display:flex;
  gap:1rem;
  margin-bottom:1rem;
}
.tabs button {
  background:var(--container);
  color:var(--text-dark);
  border:2px solid var(--color-4);
  border-radius:.75rem;
  padding:.5rem 1rem;
  font-weight:600;
  cursor:pointer;
  transition:.3s;
  font-family:"Fredoka",sans-serif;
  font-size:1.2rem;
}
.tabs button.active {
  background:var(--color-4);
  color:var(--text-main);
  border-color:var(--color-1);
}

.bento-gallery { column-count:4; column-gap:.5rem; }
.bento-item { display:inline-block; width:100%; margin-bottom:.1rem; border-radius:.5rem; overflow:hidden; cursor:pointer; transition:transform .2s ease, box-shadow .2s ease; }
.bento-item img, .bento-item video { width:100%; height:auto; display:block; object-fit:cover; }

.storyboard-item {
  display:flex;
  flex-direction:column;
  break-inside:avoid;
  margin:0 auto 1.5rem;
  max-width:500px;
}

.item-text {
  padding:.5rem 0;
}
.item-text h3 {
  margin:.3rem 0;
  font-size:1.2rem;
  font-weight:600;
}
.item-text hr {
  border:none;
  border-top:3px solid rgba(0,0,0,.2);
  margin:.3rem 0;
}
.item-text p {
  margin:0;
  font-size:1rem;
  color:var(--text-dark);
}

/* Title Divider */
.title-divider {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 1rem;
  gap: 1rem;
}
.title-divider .line {
  flex: 1;
  height: 2px;
  background-color: var(--color-6);
  opacity: 0;
  transform: scaleX(0);
  transform-origin: center;
}

#tab-title {
  font-size: 2rem;
  font-weight: 700;
  letter-spacing: 0.03em;
  margin: 0;
  white-space: nowrap;
  display: flex;
  justify-content: center;
}

#tab-title span {
  display: inline-block;
  opacity: 0;
}

@keyframes fadeInUp {
  0% { opacity: 0; transform: translateY(10px); }
  100% { opacity: 1; transform: translateY(0); }
}

@keyframes lineIn {
  0% { opacity: 0; transform: scaleX(0); }
  100% { opacity: 1; transform: scaleX(1); }
}

/* Storyboard fixes */
#storyboard.bento-gallery {
  column-count: initial;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
  gap: 2rem;
  width: 100%;
}

.storyboard-item {
  display: flex;
  flex-direction: column;
  border-radius: 12px;
  overflow: hidden;
  cursor: pointer;
}

.video-wrapper {
  position: relative;
  width: 100%;
  aspect-ratio: 16 / 9;
  overflow: hidden;
}
.video-wrapper video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}
.video-wrapper .play-overlay {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  pointer-events:none;
  opacity:0;
  transition:opacity .25s ease;
}
.video-wrapper:hover .play-overlay { opacity:1; }
.video-wrapper .play-overlay svg {
  width:40px; height:40px;
  fill:white;
  filter:drop-shadow(0 0 4px rgba(0,0,0,.5));
}

@media(max-width:1200px){.bento-gallery{column-count:3;}}
@media(max-width:900px){.bento-gallery{column-count:2;}}
@media(max-width:600px){.bento-gallery{column-count:1;}}

.music-player.staggered {
  opacity: 0;
  animation: fadeUp 0.5s forwards;
}
</style>
