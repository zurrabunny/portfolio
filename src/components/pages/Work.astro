---
import Container from "/src/components/Container.astro";
import ImageModal from "./ImageModal.astro";
import Music from "./work_modules/Music.astro";
import Illustrations from "./work_modules/Illustrations.astro";
import Animation from "./work_modules/Animations.astro";
import ThreeD from "./work_modules/ThreeD.astro";
import Storyboards from "./work_modules/Storyboards.astro";
---

<main class="content">
  <Container variant="static">
    <div class="tabs">
      <button data-tab="Illustrations" class="active">Illustrations</button>
      <button data-tab="Animation">Animation</button>
      <button data-tab="3D">3D</button>
      <button data-tab="Storyboard">Storyboard</button>
      <button data-tab="Music">Music</button>
    </div>

    <h1 id="tab-title">Illustrations</h1>

    <section class="bento-gallery" id="illustrations">
      <Illustrations />
    </section>

    <section class="bento-gallery" id="animation" style="display:none">
      <Animation />
    </section>

    <section class="bento-gallery" id="3d" style="display:none">
      <ThreeD />
    </section>

    <section class="bento-gallery" id="storyboard" style="display:none">
      <Storyboards />
    </section>

    <div class="music-row" id="music" style="display:none">
      <Music />
    </div>
  </Container>
  <ImageModal />
</main>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const animationSpeed = 0.6; // seconds
  const staggerDelay = 0.02;  // seconds per letter/item

  const tabs = document.querySelectorAll(".tabs button");
  const sections = {
    Illustrations: document.getElementById("illustrations"),
    Animation: document.getElementById("animation"),
    "3D": document.getElementById("3d"),
    Storyboard: document.getElementById("storyboard"),
    Music: document.getElementById("music")
  };
  const title = document.getElementById("tab-title");

  // Wrap title letters ONCE
  const wrapTitleLetters = () => {
    if (!title.dataset.wrapped) {
      const text = title.textContent;
      title.innerHTML = "";
      text.split("").forEach(char => {
        const span = document.createElement("span");
        span.textContent = char;
        span.style.display = "inline-block";
        span.style.opacity = 0;
        title.appendChild(span);
      });
      title.dataset.wrapped = "true";
    }
  };
  wrapTitleLetters();

  const animateTitleAndItems = (text, items) => {
    const letters = Array.from(title.querySelectorAll("span"));

    // Update letters text and reset
    letters.forEach((span, i) => {
      span.textContent = text[i] || "";
      span.style.opacity = 0;
      span.style.animation = "none";
    });

    // Animate letters staggered
    letters.forEach((span, i) => {
      setTimeout(() => {
        span.style.animation = `fadeInUp ${animationSpeed}s forwards`;
      }, i * staggerDelay * 1000);
    });

    // Animate gallery items staggered after letters
    items.forEach((item, index) => {
      const delay = (letters.length + index) * staggerDelay * 1000;
      item.style.opacity = 0;
      item.style.animation = "none";
      setTimeout(() => {
        item.style.animation = `fadeInUp ${animationSpeed}s forwards`;
      }, delay);

      // Animate nested text blocks if present
      const textBlock = item.querySelector(".item-text");
      if (textBlock) {
        textBlock.style.opacity = 0;
        textBlock.style.animation = "none";
        setTimeout(() => {
          textBlock.style.animation = `fadeInUp ${animationSpeed}s forwards`;
        }, delay + (staggerDelay * 1000 / 2));
      }
    });
  };

  // Animate music players the same way
  const animateMusicPlayers = () => {
    const musicPlayers = document.querySelectorAll("#music .music-player");
    musicPlayers.forEach((player, i) => {
      const delay = i * staggerDelay * 1000; // stagger without letters length
      player.style.opacity = 0;
      player.style.animation = "none";
      setTimeout(() => {
        player.style.animation = `fadeInUp ${animationSpeed}s forwards`;
      }, delay);

      const textBlock = player.querySelector(".music-info");
      if (textBlock) {
        textBlock.style.opacity = 0;
        textBlock.style.animation = "none";
        setTimeout(() => {
          textBlock.style.animation = `fadeInUp ${animationSpeed}s forwards`;
        }, delay + (staggerDelay * 1000 / 2));
      }
    });
  };

  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      const selected = tab.dataset.tab;

      // Update active tab
      tabs.forEach(t => t.classList.remove("active"));
      tab.classList.add("active");

      // Show/hide sections
      Object.keys(sections).forEach(key => {
        sections[key].style.display = key === selected ? (key === "Music" ? "flex" : "block") : "none";
      });

      const items = sections[selected].querySelectorAll(".bento-item");
      animateTitleAndItems(selected, items);

      if (selected === "Music") animateMusicPlayers();
    });
  });

  // Trigger default tab
  document.querySelector('.tabs button[data-tab="Illustrations"]')?.click();
});
</script>

<style>
main.content {
  flex:1;
  margin-left:260px;
  padding:2rem;
  color:var(--text-dark);
  position:relative;
  z-index:1;
}

.tabs {
  display:flex;
  gap:1rem;
  margin-bottom:1rem;
}
.tabs button {
  background:var(--container);
  color:var(--text-dark);
  border:2px solid var(--color-4);
  border-radius:.75rem;
  padding:.5rem 1rem;
  font-weight:600;
  cursor:pointer;
  transition:.3s;
  font-family:"Fredoka",sans-serif;
  font-size:1.2rem;
}
.tabs button.active {
  background:var(--color-4);
  color:var(--text-main);
  border-color:var(--color-1);
}

.bento-gallery { column-count:4; column-gap:.5rem; }
.bento-item { display:inline-block; width:100%; margin-bottom:.1rem; border-radius:.5rem; overflow:hidden; cursor:pointer; transition:transform .2s ease, box-shadow .2s ease; }
.bento-item img, .bento-item video { width:100%; height:auto; display:block; object-fit:cover; }

.storyboard-item {
  display:flex;
  flex-direction:column;
  break-inside:avoid;
  margin:0 auto 1.5rem;
  max-width:500px;
}

.item-text {
  padding:.5rem 0;
}
.item-text h3 {
  margin:.3rem 0;
  font-size:1.2rem;
  font-weight:600;
}
.item-text hr {
  border:none;
  border-top:3px solid rgba(0,0,0,.2);
  margin:.3rem 0;
}
.item-text p {
  margin:0;
  font-size:1rem;
  color:var(--text-dark);
}

#tab-title {
  display: flex;
  justify-content: center;
  font-size: 2rem;
  margin-bottom: 1rem;
  font-weight: 700;
  letter-spacing: 0.03em;
}

#tab-title span {
  display: inline-block;
  opacity: 0;
}

/* Storyboard fixes */
#storyboard.bento-gallery {
  column-count: initial;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
  gap: 2rem;
  width: 100%;
}

/* Keep storyboard-item styling */
.storyboard-item {
  display: flex;
  flex-direction: column;
  border-radius: 12px;
  overflow: hidden;
  cursor: pointer;
}

.video-wrapper {
  position: relative;
  width: 100%;
  aspect-ratio: 16 / 9;
  overflow: hidden;
}

.video-wrapper video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.video-wrapper .play-overlay {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  pointer-events:none;
  opacity:0;
  transition:opacity .25s ease;
}
.video-wrapper:hover .play-overlay {
  opacity:1;
}
.video-wrapper .play-overlay svg {
  width:40px;
  height:40px;
  fill:white;
  filter:drop-shadow(0 0 4px rgba(0,0,0,.5));
}

@media(max-width:1200px){.bento-gallery{column-count:3;}}
@media(max-width:900px){.bento-gallery{column-count:2;}}
@media(max-width:600px){.bento-gallery{column-count:1;}}

@keyframes fadeInUp {
  0% {
    opacity: 0;
    transform: translateY(10px);
  }
  100% {
    opacity: 1;
    transform: translateY(0);
  }
}

.music-player.staggered {
  opacity: 0; /* start invisible */
  animation: fadeUp 0.5s forwards;
}

</style>
