---
import "../styles/global.css";
import BackgroundGrid from '../components/BackgroundGrid.astro';
import Sidebar from '../components/Sidebar.astro';
import ContentSwitcher from '../components/ContentSwitcher.astro';
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>zurra's site of fun and whimsy</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
  </head>

  <body>
    <!-- Page content -->
    <div id="page-wrapper">
      <BackgroundGrid />
      <Sidebar />
	  <!-- Dark Mode Toggle -->
    <button class="dark-mode-toggle" id="dark-mode-toggle">
      <svg class="icon moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 12.79A9 9 0 1111.21 3a7 7 0 009.79 9.79z"/>
      </svg>
      <svg class="icon sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="5"/>
        <line x1="12" y1="1" x2="12" y2="3"/>
        <line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/>
        <line x1="21" y1="12" x2="23" y2="12"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
      </svg>
    </button>

    <!-- Mobile Dropdown -->
    <div class="mobile-dropdown">
      <button class="dropdown-toggle">â˜°</button>
      <div class="dropdown-content">
        <a href="#" data-target="about">About</a>
        <a href="#" data-target="work">Works</a>
        <a href="#" data-target="blog">Growth and Goals</a>
        <a href="#" data-target="contact">Contact</a>
      </div>
    </div>
      <main id="main-content" class="content">
	  <thing class="thing-wrapper">
        <ContentSwitcher client:load />
	  </thing>
      </main>
    </div>
  </body>
</html>

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  overflow-x: hidden;
  box-sizing: border-box;
}

#page-wrapper {
  display: flex;
  flex-direction: row;
  width: 100%;
  max-width: 100%;
  overflow-x: hidden;
  box-sizing: border-box;
  align-items: flex-start;
}

main.content {
  width: 100%;
  max-width: 100%;
  overflow-x: hidden;
  box-sizing: border-box;
}

/* Background grid */
.bg-grid-root {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -10;
  pointer-events: none;
  overflow: hidden;
}
#bg-grid-canvas { width: 100%; height: 100%; display: block; }

/* Mobile Dropdown */
.mobile-dropdown {
  display: none;
  position: absolute;
  top: 1rem;
  left: 1rem;
  z-index: 300;
}

.dropdown-toggle {
  background-color: transparent;
  color: var(--text-main);
  border: none;
  padding: 8px 12px;
  border-radius: 10px;
  font-size: 20px;
  cursor: pointer;
  transition: background 0.2s ease, transform 0.1s ease;
}
.dropdown-toggle:hover { background: var(--color-3); transform: scale(1.05); }

.dropdown-content {
  overflow: hidden;
  background: var(--bg-sidebar);
  border: 2px solid var(--border-sidebar);
  border-radius: 10px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.25);
  position: absolute;
  top: 3.3rem;
  left: 0;
  width: 180px;
  max-height: 0;
  opacity: 0;
  transition: max-height 0.4s ease, opacity 0.4s ease;
}
.dropdown-content a {
  display: block;
  color: var(--text-main);
  text-decoration: none;
  padding: 10px 16px;
  transition: background 0.2s ease, padding-left 0.2s ease;
}
.dropdown-content a:hover { background: var(--color-3); padding-left: 22px; }

/* Dark Mode Toggle */
.dark-mode-toggle {
  position: fixed;
  top: 1rem;
  right: 16px;
  z-index: 20;
  width: 44px;
  height: 44px;
  border: none;
  border-radius: 12px;
  background-color: var(--color-3);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background 0.3s ease;
}
.dark-mode-toggle:hover { background-color: var(--color-2); }
.icon { width: 24px; height: 24px; stroke: var(--text-main); position: absolute; top:50%; left:50%; transform: translate(-50%,-50%); transition: opacity 0.4s ease, transform 0.4s ease; pointer-events: none; }
.moon { opacity: 1; }
.sun { opacity: 0; }

/* ===== Mobile Layout ===== */
@media (max-width: 900px) {
  .mobile-dropdown { display: block; left: 1rem; top: 1rem; }
  .mobile-dropdown .dropdown-content { left: 0; }
#page-wrapper {
  flex-direction: column;
  align-items: center;
  width: 100%;
  overflow-x: hidden;
}

  main.content { width: 100%; max-width: 500px; overflow-x: hidden; }

  .dark-mode-toggle {
    position: absolute;
    top: 1.5em;
    left: 3.6rem;
    transform: none;
    width: 40px;
    height: 40px;
    background-color: transparent;
  }
  .dark-mode-toggle:hover { background-color: transparent; }
}

html, body {
  background-color: var(--bg-grid-color-a);
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const dropdown = document.querySelector(".mobile-dropdown");
  const toggle = dropdown.querySelector(".dropdown-toggle");
  const content = dropdown.querySelector(".dropdown-content");
  const links = content.querySelectorAll("a");

  toggle.addEventListener("click", () => {
    if (dropdown.classList.contains("active")) {
      content.style.maxHeight = content.scrollHeight + "px";
      requestAnimationFrame(() => { content.style.maxHeight = "0px"; content.style.opacity = 0; });
      dropdown.classList.remove("active");
    } else {
      content.style.maxHeight = content.scrollHeight + "px";
      content.style.opacity = 1;
      dropdown.classList.add("active");
    }
  });

  links.forEach(link => {
    link.addEventListener("click", (e) => {
      e.preventDefault();
      const target = link.getAttribute("data-target");
      const event = new CustomEvent("switchContent", { detail: { target } });
      window.dispatchEvent(event);
      content.style.maxHeight = content.scrollHeight + "px";
      requestAnimationFrame(() => { content.style.maxHeight = "0px"; content.style.opacity = 0; });
      dropdown.classList.remove("active");
    });
  });

  content.addEventListener("transitionend", () => {
    if (dropdown.classList.contains("active")) content.style.maxHeight = "none";
  });
});
</script>

<script type="module" client:load>
const toggle = document.getElementById('dark-mode-toggle');
const root = document.documentElement;
const moon = toggle.querySelector('.moon');
const sun = toggle.querySelector('.sun');

const savedTheme = localStorage.getItem('darkMode');
if (savedTheme === 'enabled') {
  root.classList.add('dark-mode');
  moon.style.opacity = '0';
  moon.style.transform = 'translate(-50%, -50%) rotate(90deg)';
  sun.style.opacity = '1';
  sun.style.transform = 'translate(-50%, -50%) rotate(0deg)';
} else {
  moon.style.opacity = '1';
  moon.style.transform = 'translate(-50%, -50%) rotate(0deg)';
  sun.style.opacity = '0';
  sun.style.transform = 'translate(-50%, -50%) rotate(-90deg)';
}

toggle.addEventListener('click', () => {
  const isDark = root.classList.toggle('dark-mode');
  if (isDark) {
    localStorage.setItem('darkMode', 'enabled');
    moon.style.opacity = '0';
    moon.style.transform = 'translate(-50%, -50%) rotate(90deg)';
    sun.style.opacity = '1';
    sun.style.transform = 'translate(-50%, -50%) rotate(0deg)';
  } else {
    localStorage.setItem('darkMode', 'disabled');
    sun.style.opacity = '0';
    sun.style.transform = 'translate(-50%, -50%) rotate(-90deg)';
    moon.style.opacity = '1';
    moon.style.transform = 'translate(-50%, -50%) rotate(0deg)';
  }
});
</script>

<!-- Background Grid -->
<div class="bg-grid-root">
  <canvas id="bg-grid-canvas" aria-hidden="true"></canvas>
</div>

<script type="module">
(() => {
  const canvas = document.getElementById("bg-grid-canvas");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");
  ctx.imageSmoothingEnabled = false;

  let width, height, dpr;
  let cellSize = 64;
  const scrollSpeed = 0.2;
  const diagonal = true;

  function parseColor(color) {
    color = color.trim();
    if (color.startsWith('#')) return [parseInt(color.slice(1,3),16),parseInt(color.slice(3,5),16),parseInt(color.slice(5,7),16),1];
    else if (color.startsWith('rgba')) return color.match(/\d+\.?\d*/g).map(Number);
    else if (color.startsWith('rgb')) return [...color.match(/\d+/g).map(Number),1];
    return [0,0,0,1];
  }
  function lerpArr(a,b,t){return a.map((v,i)=>v+(b[i]-v)*t);}
  function rgbaStr(arr){return `rgba(${Math.round(arr[0])},${Math.round(arr[1])},${Math.round(arr[2])},${arr[3]})`; }

  let rootStyles = getComputedStyle(document.documentElement);
  let targetA = parseColor(rootStyles.getPropertyValue('--bg-grid-color-a'));
  let targetB = parseColor(rootStyles.getPropertyValue('--bg-grid-color-b'));
  let currentA = [...targetA], currentB=[...targetB];
  const transitionSpeed=0.08;
  let offsetX=0, offsetY=0;

  function resize() {
    dpr = Math.max(1, window.devicePixelRatio || 1);
    width = window.innerWidth;
    height = window.innerHeight;
    cellSize = width<=900?40:64;
    canvas.width = width*dpr;
    canvas.height = height*dpr;
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }

  function draw() {
    currentA=lerpArr(currentA,targetA,transitionSpeed);
    currentB=lerpArr(currentB,targetB,transitionSpeed);
    ctx.clearRect(0,0,width,height);

    if(width>900){
      const cols=Math.ceil(width/cellSize)+2;
      const rows=Math.ceil(height/cellSize)+2;
      for(let y=-1;y<rows;y++){
        for(let x=-1;x<cols;x++){
          ctx.fillStyle=(x+y)%2===0?rgbaStr(currentA):rgbaStr(currentB);
          ctx.fillRect(Math.round(x*cellSize+offsetX),Math.round(y*cellSize+offsetY),cellSize,cellSize);
        }
      }
      if(diagonal){offsetX-=scrollSpeed;offsetY-=scrollSpeed;}
      else offsetX-=scrollSpeed;
      if(offsetX<=-cellSize) offsetX+=cellSize;
      if(offsetY<=-cellSize) offsetY+=cellSize;
    }else{
      ctx.fillStyle=rgbaStr(currentA);
      ctx.fillRect(0,0,width,height);
      offsetX=0; offsetY=0;
    }
    requestAnimationFrame(draw);
  }

  resize();
  draw();
  window.addEventListener("resize", resize,{passive:true});

  const observer = new MutationObserver(()=>{
    rootStyles = getComputedStyle(document.documentElement);
    targetA=parseColor(rootStyles.getPropertyValue('--bg-grid-color-a'));
    targetB=parseColor(rootStyles.getPropertyValue('--bg-grid-color-b'));
  });
  observer.observe(document.documentElement,{attributes:true,attributeFilter:['class']});
})();
</script>
